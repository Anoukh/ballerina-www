// initialise stream handler
future f1 = start initStreamConsumer();

stream<StockUpdate> inStream;

function initStreamConsumer () {
    stream<Result> resultStream;
    resultStream.subscribe(resultEventHandler);

    forever {
        from inStream where symbol == "GOOG"
            window timeBatch(3000)
        select 
            symbol,
            count(symbol) as count,
            avg(price) as average
        group by symbol => (Result[] result) {
           resultStream.publish(result);
        }
    }
}